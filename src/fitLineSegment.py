import numpy as np
from timeit import default_timer as timer

def fit_line_segment(points):
    if points.shape[0] < 2:
        raise ValueError("Need at least 2 points to fit a line.")

    centroid = points.mean(axis=0)
    cov = np.cov(points - centroid, rowvar=False)

    eigvals, eigvecs = np.linalg.eigh(cov)

    # Handle degenerate case: all points identical
    if np.allclose(eigvals, 0):
        return centroid, centroid, np.array([1, 0]), 0.0

    direction = eigvecs[:, np.argmax(eigvals)]
    direction /= np.linalg.norm(direction)

    projections = (points - centroid) @ direction
    p1 = centroid + projections.min() * direction
    p2 = centroid + projections.max() * direction

    # Error = SSE = N * min eigenvalue
    N = points.shape[0]
    error = N * np.min(eigvals)

    return p1, p2, direction, error

if __name__ == '__main__':
    test_edge1 = [(232, 214), (233, 214), (233, 215), (233, 216), (234, 216), (234, 217), (234, 218), (233, 218), (233, 219), (233, 220), (233, 221), (233, 222), (233, 223), (233, 224), (233, 225), (232, 225), (232, 226), (233, 226), (233, 227), (233, 228), (232, 228), (232, 229), (232, 230), (231, 230), (231, 231), (231, 232), (230, 232), (230, 233), (230, 234), (231, 234), (231, 235), (231, 236), (231, 237), (230, 237), (230, 238), (230, 239), (229, 239), (229, 240), (230, 240), (230, 241), (229, 241), (229, 242), (229, 243), (229, 244), (228, 244), (228, 245), (228, 246), (228, 247), (228, 248), (228, 249), (228, 250), (228, 251), (227, 251), (227, 252), (227, 253), (228, 253), (228, 254), (227, 254), (227, 255), (226, 255), (226, 256), (227, 256), (227, 257), (226, 257), (226, 258), (226, 259)]
    test_edge2 = [(430, 266), (430, 267), (431, 267), (431, 268), (432, 268), (432, 269), (432, 270), (433, 270), (433, 271), (433, 272), (434, 272), (434, 273), (434, 274), (435, 274), (435, 275), (436, 275), (436, 276), (436, 277), (437, 277), (437, 278), (437, 279), (438, 279), (438, 280), (438, 281), (439, 281), (439, 282), (440, 282), (440, 283), (440, 284), (441, 284), (441, 285), (441, 286), (442, 286), (442, 287), (443, 287), (443, 288), (443, 289), (444, 289), (444, 290), (444, 291), (445, 291), (445, 292), (445, 293), (446, 293), (446, 294), (447, 294), (447, 295), (447, 296), (448, 296), (448, 297), (448, 298), (449, 298), (449, 299), (449, 300), (450, 300), (450, 301), (451, 301), (451, 302), (451, 303), (452, 303), (452, 304), (452, 305), (453, 305), (453, 306), (454, 306), (454, 307), (454, 308), (455, 308), (455, 309), (455, 310), (456, 310), (456, 311), (456, 312), (457, 312), (457, 313), (458, 313), (458, 314), (458, 315), (459, 315), (459, 316), (459, 317), (460, 317), (460, 318), (460, 319), (461, 319), (461, 320), (462, 320), (462, 321), (462, 322), (463, 322), (463, 323), (463, 324), (464, 324), (464, 325), (464, 326), (465, 326), (465, 327), (466, 327), (466, 328), (466, 329), (467, 329), (467, 330), (467, 331), (468, 331), (468, 332), (469, 332), (469, 333), (469, 334), (470, 334), (470, 335), (470, 336), (471, 336), (471, 337), (471, 338), (471, 339), (470, 339), (470, 340), (469, 340), (468, 340), (468, 341), (467, 341), (466, 341), (466, 342), (465, 342), (465, 343), (464, 343), (463, 343), (463, 344), (462, 344), (461, 344), (461, 345), (460, 345), (460, 346), (459, 346), (458, 346), (458, 347), (457, 347), (456, 347), (456, 348), (455, 348), (454, 348), (454, 349), (453, 349), (453, 350), (452, 350), (451, 350), (451, 351), (450, 351), (449, 351), (449, 352), (448, 352), (447, 352), (447, 353), (446, 353), (446, 354), (445, 354), (444, 354), (444, 355), (443, 355), (442, 355), (442, 356), (441, 356), (440, 356), (440, 357), (439, 357), (439, 358), (438, 358), (437, 358), (437, 359), (436, 359), (435, 359), (435, 360), (434, 360), (434, 361), (433, 361), (432, 361), (432, 362), (431, 362), (430, 362), (430, 363), (429, 363), (428, 363), (428, 364), (427, 364), (427, 365), (426, 365), (425, 365), (425, 366), (424, 366), (423, 366), (423, 367), (422, 367), (421, 367), (421, 368), (420, 368), (420, 369), (419, 369), (418, 369), (418, 370), (417, 370), (416, 370), (416, 371), (415, 371), (414, 371), (414, 372), (413, 372), (413, 373), (412, 373), (411, 373), (411, 374), (410, 374), (409, 374), (409, 375), (408, 375), (408, 376), (407, 376), (407, 377), (406, 377), (406, 378), (405, 378), (405, 379), (404, 379), (404, 380), (403, 380), (403, 381), (402, 381), (401, 381), (401, 382), (400, 382), (399, 382), (399, 383), (398, 383), (397, 383), (397, 384), (396, 384), (396, 385), (395, 385), (394, 385), (394, 386), (393, 386), (392, 386), (392, 387), (391, 387), (390, 387), (390, 388), (389, 388), (389, 389), (388, 389), (387, 389), (387, 390), (386, 390), (385, 390), (385, 391), (384, 391), (383, 391), (383, 392), (382, 392), (382, 393), (381, 393), (380, 393), (380, 394), (379, 394), (378, 394), (378, 395), (377, 395), (377, 396), (376, 396), (375, 396), (375, 397), (374, 397), (373, 397), (373, 398), (372, 398), (371, 398), (371, 399), (370, 399), (370, 400), (369, 400), (368, 400), (368, 401), (367, 401), (366, 401), (366, 402), (365, 402), (364, 402), (364, 403), (363, 403), (363, 404), (362, 404), (361, 404), (361, 405), (360, 405), (359, 405), (359, 406), (358, 406), (357, 406), (357, 407), (356, 407), (356, 408), (355, 408), (354, 408), (354, 409), (353, 409), (352, 409), (352, 410), (351, 410), (351, 411), (350, 411), (349, 411), (349, 412), (348, 412), (347, 412), (347, 413), (346, 413), (345, 413), (345, 414), (344, 414), (344, 415), (343, 415), (342, 415), (342, 416), (341, 416), (340, 416), (340, 417), (339, 417), (338, 417), (338, 416), (337, 416), (337, 417), (336, 417), (335, 417), (335, 418), (334, 418), (333, 418), (333, 419), (332, 419), (331, 419), (331, 420), (330, 420), (330, 421), (329, 421), (328, 421), (328, 422), (327, 422), (326, 422), (326, 423), (325, 423), (324, 423), (324, 424), (323, 424), (322, 424), (321, 424), (321, 423), (320, 423), (320, 424), (319, 424), (318, 424), (318, 425), (317, 425), (317, 426), (316, 426), (315, 426), (315, 427), (314, 427), (313, 427), (313, 428), (312, 428), (311, 428), (311, 429), (310, 429), (310, 430), (309, 430), (308, 430), (308, 431), (307, 431), (306, 431), (306, 432), (305, 432), (304, 432), (304, 433), (303, 433), (303, 434), (302, 434), (301, 434), (301, 435), (300, 435), (299, 435), (299, 436), (298, 436), (297, 436), (297, 437), (296, 437), (296, 438), (295, 438), (294, 438), (294, 439), (293, 439), (292, 439), (292, 440), (291, 440), (291, 441), (290, 441), (289, 441), (289, 442), (288, 442), (287, 442), (287, 443), (286, 443), (285, 443), (285, 444), (284, 444), (284, 445), (283, 445), (282, 445), (282, 446), (281, 446), (280, 446), (280, 447), (279, 447), (278, 447), (278, 448), (277, 448), (277, 449), (276, 449), (275, 449), (275, 450), (274, 450), (273, 450), (273, 451), (272, 451), (271, 451), (271, 452), (270, 452), (270, 453), (269, 453), (268, 453), (268, 454), (267, 454), (266, 454), (266, 455), (265, 455), (265, 456), (264, 456), (263, 456), (263, 457), (262, 457), (261, 457), (261, 458), (260, 458), (259, 458), (259, 459), (258, 459), (258, 460), (257, 460), (256, 460), (256, 461), (255, 461), (254, 461), (254, 462), (253, 462), (252, 462), (252, 463), (251, 463), (251, 464), (250, 464), (249, 464), (249, 465), (248, 465), (247, 465), (247, 466), (246, 466), (245, 466), (245, 467), (244, 467), (244, 468), (243, 468), (243, 467), (242, 467), (242, 466), (242, 465), (241, 465), (241, 464), (240, 464), (240, 463), (240, 462), (239, 462), (239, 461), (239, 460), (238, 460), (238, 459), (238, 458), (237, 458), (237, 457), (236, 457), (236, 456), (236, 455), (235, 455), (235, 454), (235, 453), (234, 453), (234, 452), (234, 451), (235, 451), (235, 450), (236, 450), (236, 449), (237, 449), (237, 448), (238, 448), (238, 447), (239, 447), (239, 446), (239, 445), (239, 444), (238, 444), (238, 443), (238, 442), (237, 442), (237, 441), (236, 441), (236, 440), (236, 439), (235, 439), (235, 438), (235, 437), (234, 437), (234, 436), (234, 435), (233, 435), (233, 434), (233, 433), (232, 433), (232, 432), (231, 432), (231, 431), (231, 430), (230, 430), (230, 429), (230, 428), (229, 428), (229, 427), (228, 427), (228, 426), (228, 425), (227, 425), (227, 424), (228, 424), (228, 423), (227, 423), (227, 422), (226, 422), (226, 421), (225, 421), (225, 420), (224, 420), (224, 419), (224, 418), (223, 418), (223, 417), (224, 417), (224, 416), (224, 415), (224, 414), (223, 414), (223, 413), (222, 413), (222, 412), (222, 411), (221, 411), (221, 410), (221, 409), (220, 409), (220, 408), (219, 408), (219, 407), (219, 406), (218, 406), (218, 405), (218, 404), (217, 404), (217, 403), (217, 402), (216, 402), (216, 401), (215, 401), (215, 400), (214, 400), (214, 399), (213, 399), (213, 398), (212, 398), (212, 397)]

    test_edge1 = np.array(test_edge1,dtype=int)
    test_edge2 = np.array(test_edge2,dtype=int)

    start = timer()
    p1, p2, direction, loss = fit_line_segment(test_edge1)
    end = timer()
    print("test1:", end-start, 'seconds')
    print("points count:", len(test_edge1))
    print(p1, p2, "direction: ", direction, "loss:", loss)

    start = timer()
    p1, p2, direction, loss = fit_line_segment(test_edge2)
    end = timer()
    print("test2:", end-start, 'seconds')
    print("points count:", len(test_edge2))
    print(p1, p2, "direction: ", direction, "loss:", loss)
